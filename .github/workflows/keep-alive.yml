name: Keep Services Alive

# æ¯æ—¥å®Ÿè¡Œ + æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
on:
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ = æ—¥æœ¬æ™‚é–“ æ­£åˆ
    - cron: '0 3 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Keep Supabase Active
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸ“¡ Supabaseã«ã‚¯ã‚¨ãƒªã‚’é€ä¿¡ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ç¶­æŒ..."

          # ç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
          if [ -z "${SUPABASE_URL}" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: SUPABASE_URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Settings > Secrets and variables > Actions ã§è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi

          if [ -z "${SUPABASE_ANON_KEY}" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: SUPABASE_ANON_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Settings > Secrets and variables > Actions ã§è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi

          echo "ğŸ” Supabase URL: ${SUPABASE_URL}"
          echo "ğŸ”‘ Anon Key: ${SUPABASE_ANON_KEY:0:20}... (ãƒã‚¹ã‚¯æ¸ˆã¿)"

          # è¤‡æ•°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿè¡Œ
          # å­˜åœ¨ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ç¢ºå®Ÿãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ç”Ÿæˆ

          success_count=0

          # auth_user_scoresãƒ†ãƒ¼ãƒ–ãƒ«
          echo "ğŸ“¤ ã‚¯ã‚¨ãƒª1: auth_user_scoresãƒ†ãƒ¼ãƒ–ãƒ«..."
          response1=$(curl -s -w "\n%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "${SUPABASE_URL}/rest/v1/auth_user_scores?select=*&limit=1" 2>&1 || echo "CURL_FAILED")

          if [ "$response1" != "CURL_FAILED" ]; then
            http_code1=$(echo "$response1" | tail -n1)
            body1=$(echo "$response1" | head -n-1)
            echo "ğŸ“¥ auth_user_scores HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code1"
            if [ "$http_code1" = "200" ] || [ "$http_code1" = "206" ]; then
              echo "âœ… auth_user_scoresã‚¯ã‚¨ãƒªæˆåŠŸ"
              success_count=$((success_count + 1))
            else
              echo "âš ï¸ auth_user_scoresè©³ç´°: $body1"
            fi
          else
            echo "âš ï¸ auth_user_scores curlã‚¨ãƒ©ãƒ¼"
          fi

          # profilesãƒ†ãƒ¼ãƒ–ãƒ«
          echo "ğŸ“¤ ã‚¯ã‚¨ãƒª2: profilesãƒ†ãƒ¼ãƒ–ãƒ«..."
          response2=$(curl -s -w "\n%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "${SUPABASE_URL}/rest/v1/profiles?select=*&limit=1" 2>&1 || echo "CURL_FAILED")

          if [ "$response2" != "CURL_FAILED" ]; then
            http_code2=$(echo "$response2" | tail -n1)
            body2=$(echo "$response2" | head -n-1)
            echo "ğŸ“¥ profiles HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code2"
            if [ "$http_code2" = "200" ] || [ "$http_code2" = "206" ]; then
              echo "âœ… profilesã‚¯ã‚¨ãƒªæˆåŠŸ"
              success_count=$((success_count + 1))
            else
              echo "âš ï¸ profilesè©³ç´°: $body2"
            fi
          else
            echo "âš ï¸ profiles curlã‚¨ãƒ©ãƒ¼"
          fi

          # æœ€ä½1ã¤æˆåŠŸã—ã¦ã„ã‚Œã°OK
          echo "ğŸ“Š æˆåŠŸã—ãŸã‚¯ã‚¨ãƒªæ•°: $success_count"
          if [ "$success_count" -gt 0 ]; then
            echo "ğŸ¯ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æˆåŠŸ ($success_count/2 ãƒ†ãƒ¼ãƒ–ãƒ«)"
          else
            echo "âŒ å…¨ã¦ã®ã‚¯ã‚¨ãƒªãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Keep Vercel Deployment Active
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "ğŸŒ Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹..."

          # Vercel URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
          if [ -n "${VERCEL_URL}" ]; then
            response=$(curl -s -w "\n%{http_code}" -L "${VERCEL_URL}")
            http_code=$(echo "$response" | tail -n1)

            if [ "$http_code" -eq 200 ]; then
              echo "âœ… Vercelã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ (HTTP $http_code)"
            else
              echo "âš ï¸ Vercelã‚¢ã‚¯ã‚»ã‚¹å¤±æ•— (HTTP $http_code)"
              # Vercelã®å¤±æ•—ã¯è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã¨ã—ãªã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
            fi
          else
            echo "â„¹ï¸ VERCEL_URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
          fi

      - name: Summary
        run: |
          echo "ğŸ‰ Keep-Aliveã‚¸ãƒ§ãƒ–å®Œäº†"
          echo "æ¬¡å›å®Ÿè¡Œ: 24æ™‚é–“å¾Œï¼ˆæ¯æ—¥ï¼‰"
