name: Keep Services Alive

# 3æ—¥ã”ã¨ï¼ˆ72æ™‚é–“ï¼‰ã«å®Ÿè¡Œ + æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
on:
  schedule:
    # æ¯é€±æœˆæ›œãƒ»æœ¨æ›œã®åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ = æ—¥æœ¬æ™‚é–“ æ­£åˆ
    - cron: '0 3 * * 1,4'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Keep Supabase Active
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸ“¡ Supabaseã«ã‚¯ã‚¨ãƒªã‚’é€ä¿¡ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ç¶­æŒ..."

          # ç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
          if [ -z "${SUPABASE_URL}" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: SUPABASE_URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Settings > Secrets and variables > Actions ã§è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi

          if [ -z "${SUPABASE_ANON_KEY}" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: SUPABASE_ANON_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Settings > Secrets and variables > Actions ã§è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi

          echo "ğŸ” Supabase URL: ${SUPABASE_URL}"
          echo "ğŸ”‘ Anon Key: ${SUPABASE_ANON_KEY:0:20}... (ãƒã‚¹ã‚¯æ¸ˆã¿)"

          # profilesãƒ†ãƒ¼ãƒ–ãƒ«ã«ç°¡å˜ãªã‚¯ã‚¨ãƒªã‚’é€ä¿¡ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã—ãªã„ï¼‰
          echo "ğŸ“¤ ã‚¯ã‚¨ãƒªé€ä¿¡ä¸­..."
          response=$(curl -s -w "\n%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "${SUPABASE_URL}/rest/v1/profiles?select=count" || echo "CURL_FAILED")

          if [ "$response" = "CURL_FAILED" ]; then
            echo "âŒ curlã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "ğŸ“¥ HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: $http_code"
          echo "ğŸ“„ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£: $body"

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 206 ]; then
            echo "âœ… Supabaseã‚¯ã‚¨ãƒªæˆåŠŸ (HTTP $http_code)"
          else
            echo "âš ï¸ Supabaseã‚¯ã‚¨ãƒªå¤±æ•— (HTTP $http_code)"
            echo "è©³ç´°: $body"
            exit 1
          fi

      - name: Keep Vercel Deployment Active
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "ğŸŒ Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹..."

          # Vercel URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
          if [ -n "${VERCEL_URL}" ]; then
            response=$(curl -s -w "\n%{http_code}" -L "${VERCEL_URL}")
            http_code=$(echo "$response" | tail -n1)

            if [ "$http_code" -eq 200 ]; then
              echo "âœ… Vercelã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ (HTTP $http_code)"
            else
              echo "âš ï¸ Vercelã‚¢ã‚¯ã‚»ã‚¹å¤±æ•— (HTTP $http_code)"
              # Vercelã®å¤±æ•—ã¯è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã¨ã—ãªã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
            fi
          else
            echo "â„¹ï¸ VERCEL_URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
          fi

      - name: Summary
        run: |
          echo "ğŸ‰ Keep-Aliveã‚¸ãƒ§ãƒ–å®Œäº†"
          echo "æ¬¡å›å®Ÿè¡Œ: 3æ—¥å¾Œ"
